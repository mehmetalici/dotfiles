#!/usr/bin/env bash

# Color variables
BLUE='\033[1;34m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
NC='\033[0m' # No Color

# URL for downloading VSCode
VSCODE_URL="https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64"

# List of VSCode extensions to install
VSCODE_EXTENSIONS=(
    "ms-python.python"
    "GitHub.copilot"
    "ms-azuretools.vscode-docker"
    "ms-vscode-remote.remote-ssh"
    "github.vscode-github-actions"
)

# Function to check if running inside Docker
is_docker() {
    # Check for the /.dockerenv file or use the cgroup info to detect Docker
    if [ -f "/.dockerenv" ]; then
        return 0
    elif grep -qE "(docker|lxc)" /proc/1/cgroup; then
        return 0
    else
        return 1
    fi
}

# Function to check if VS Code is installed
is_vscode_installed() {
    if command -v code &> /dev/null; then
        return 0
    else
        return 1
    fi
}

# Check if running in WSL2 or Docker
if grep -q microsoft /proc/version; then
    echo -e "\n${YELLOW}INFO: WSL2 Detected${NC}"
    echo -e "${YELLOW} - Skipping Visual Studio Code installation as the system is running in WSL2.${NC}\n"
elif is_docker; then
    echo -e "\n${YELLOW}INFO: Docker Detected${NC}"
    echo -e "${YELLOW} - Skipping Visual Studio Code installation as the system is running in Docker.${NC}\n"
else
    # Check if VS Code is already installed
    if is_vscode_installed; then
        echo -e "${GREEN} - VS Code is already installed. Skipping installation.${NC}"
    else
        echo -e "\n${BLUE}INFO: Install VS Code${NC}"
        echo -e "${GREEN} - Not running in WSL2 or Docker, and VS Code is not installed. Proceeding with Visual Studio Code installation...${NC}"

        # Create the downloads directory if it doesn't exist
        mkdir -p ~/downloads
        echo -e "${GREEN} - Created ~/downloads directory (if not already present).${NC}"

        # Download the VSCode deb package
        echo -e "${GREEN} - Downloading Visual Studio Code...${NC}"
        wget "$VSCODE_URL" -O ~/downloads/vscode.deb

        # Install the downloaded VSCode package
        echo -e "${GREEN} - Installing Visual Studio Code...${NC}"
        sudo apt install -y ~/downloads/vscode.deb
    fi

    # Check and install VSCode extensions
    if is_vscode_installed; then
        # Get the list of currently installed extensions
        INSTALLED_EXTENSIONS=$(code --list-extensions)

        echo -e "${GREEN} - Checking and installing VSCode extensions...${NC}"
        for extension in "${VSCODE_EXTENSIONS[@]}"; do
            if echo "$INSTALLED_EXTENSIONS" | grep -q "$extension"; then
                echo -e "${YELLOW}   -> Already installed: $extension${NC}"
            else
                code --install-extension "$extension"
                echo -e "${GREEN}   -> Installed: $extension${NC}"
            fi
        done

        echo -e "${GREEN} - All required extensions installed successfully!${NC}\n"
    else
        echo -e "${RED}ERROR: Unable to verify or install extensions because VS Code is not installed.${NC}"
    fi
fi
